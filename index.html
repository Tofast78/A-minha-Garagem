<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cat√°logo de Viaturas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card:hover{ box-shadow: 0 10px 35px rgba(2,6,23,.08) }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-white to-slate-50 text-slate-900">
  <!-- Header -->
  <header class="sticky top-0 z-40 border-b bg-white/80 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <a class="flex items-center gap-3" href="#/">
        <span id="brandLogoWrap" class="grid place-items-center w-10 h-10 rounded-xl bg-slate-900 text-white overflow-hidden">
          <span id="brandEmoji" class="text-lg">üöó</span>
          <img id="brandLogo" alt="Logo" class="w-full h-full object-cover hidden" />
        </span>
        <span id="brandTitle" class="text-xl font-semibold">Cat√°logo de Viaturas</span>
      </a>
      <span id="count" class="text-sm text-slate-500"></span>
      <div class="ml-auto hidden md:flex items-center gap-2 w-full max-w-md">
        <span class="text-slate-500">üîé</span>
        <input id="q" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="Procurar por nome, matr√≠cula, categoria..." />
      </div>
      <div class="ml-3 flex items-center gap-2">
        <button id="btnConfig" class="px-3 py-2 text-sm rounded-md border bg-white">‚öôÔ∏è Configurar</button>
        <select id="role" class="border rounded-md px-2 py-1 text-sm">
          <option value="user" selected>Utilizador</option>
          <option value="admin">Admin</option>
        </select>
        <span id="badge" class="text-xs px-2 py-1 rounded-full border bg-slate-50 text-slate-700 border-slate-200">Utilizador</span>
      </div>
    </div>
  </header>

  <!-- Hero / Controls -->
  <section class="border-b bg-gradient-to-r from-slate-50 to-slate-100">
    <div class="max-w-7xl mx-auto px-4 py-6">
      <div class="grid gap-4 md:grid-cols-6 items-end">
        <div class="md:col-span-2">
          <h1 class="text-2xl font-semibold">A tua garagem, organizada</h1>
          <p class="text-slate-600 text-sm mt-1">Lista moderna com pesquisa, filtros e detalhes r√°pidos. Datas em <strong>DD/MM/AAAA</strong>.</p>
        </div>
        <div class="md:col-span-4 grid sm:grid-cols-2 md:grid-cols-4 gap-3">
          <div>
            <label class="text-xs text-slate-500">Categoria</label>
            <select id="fCategoria" class="w-full border rounded-lg px-3 py-2 text-sm"><option value="">Todas</option></select>
          </div>
          <div>
            <label class="text-xs text-slate-500">Estado</label>
            <select id="fEstado" class="w-full border rounded-lg px-3 py-2 text-sm"><option value="">Todos</option><option>Operacional</option><option>Oficina</option><option>Reserva</option><option>Inativo</option></select>
          </div>
          <div>
            <label class="text-xs text-slate-500">Ordenar por</label>
            <select id="fSort" class="w-full border rounded-lg px-3 py-2 text-sm">
              <option value="nome">Nome (A‚ÄìZ)</option>
              <option value="matricula">Matr√≠cula (A‚ÄìZ)</option>
              <option value="prox">Pr√≥x. Manuten√ß√£o (mais cedo)</option>
            </select>
          </div>
          <div class="flex gap-2 items-end">
            <button id="btnClear" class="px-3 py-2 text-sm rounded-md border bg-white">Limpar</button>
            <div class="flex md:hidden items-center gap-2 ml-auto">
              <span class="text-slate-500">üîé</span>
              <input id="q-m" class="w-40 border rounded-lg px-3 py-2 text-sm" placeholder="Pesquisar..." />
            </div>
          </div>
        </div>
      </div>
      <div id="notice" class="hidden mt-4 text-sm rounded-lg border p-3"></div>
    </div>
  </section>

  <!-- Grid -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    <div id="grid" class="grid gap-5 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4"></div>
    <div id="empty" class="hidden text-center text-slate-600 py-20">üòï Sem resultados para os filtros atuais.</div>
  </main>

  <!-- Card Template -->
  <template id="card-tpl">
    <div class="card overflow-hidden rounded-2xl border bg-white">
      <a class="block" data-link>
        <div class="relative aspect-video bg-slate-100 overflow-hidden" data-figure>
          <div class="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent opacity-0 group-hover:opacity-100 transition"></div>
          <div class="grid place-items-center h-full text-slate-400 text-sm">üñºÔ∏è Sem foto</div>
          <span class="absolute left-2 top-2 text-[11px] px-2 py-0.5 rounded-full bg-white/90 border" data-chip-matricula></span>
        </div>
      </a>
      <div class="p-4 border-t">
        <div class="text-base font-semibold flex items-center gap-2">
          <span class="truncate" data-nome></span>
          <span class="ml-auto text-[11px] px-2 py-0.5 rounded-full bg-slate-50 text-slate-700 border border-slate-200" data-chip-categoria></span>
        </div>
        <div class="mt-2 text-sm text-slate-600 flex justify-between">
          <span>Pr√≥x. manuten√ß√£o</span>
          <span class="font-medium" data-proxmanut></span>
        </div>
        <div class="mt-2 text-sm hidden" data-preco></div>
        <div class="mt-3 flex justify-end">
          <button class="px-3 py-2 text-sm rounded-md border bg-slate-900 text-white" data-cta>Ver detalhes</button>
        </div>
      </div>
    </div>
  </template>

  <!-- Detail Dialog -->
  <dialog id="dlg" class="rounded-2xl border p-0 w-[min(1000px,95vw)] overflow-hidden">
    <div class="p-4 border-b flex items-center justify-between bg-white">
      <div class="flex items-center gap-3">
        <span class="grid place-items-center w-9 h-9 rounded-lg bg-slate-900 text-white">üöò</span>
        <div>
          <div class="text-lg font-semibold" id="dlg-title"></div>
          <div class="text-xs text-slate-500" id="dlg-sub"></div>
        </div>
      </div>
      <button id="dlg-close" class="px-3 py-2 text-sm rounded-md border bg-white">Fechar</button>
    </div>
    <div class="grid md:grid-cols-5 gap-0">
      <div class="md:col-span-3 bg-slate-100">
        <div class="aspect-video overflow-hidden">
          <img id="dlg-main" class="w-full h-full object-cover" alt="Foto principal" />
        </div>
        <div class="p-3 border-t flex gap-2 flex-wrap" id="dlg-thumbs"></div>
      </div>
      <div class="md:col-span-2 p-5 grid gap-3 text-sm bg-white">
        <div class="grid gap-2">
          <div class="flex justify-between border-b pb-1"><div class="text-slate-500">Matr√≠cula</div><div id="dlg-matricula" class="font-medium"></div></div>
          <div class="flex justify-between border-b pb-1"><div class="text-slate-500">Categoria</div><div id="dlg-categoria" class="font-medium"></div></div>
          <div class="flex justify-between border-b pb-1"><div class="text-slate-500">Pr√≥x. Manuten√ß√£o</div><div id="dlg-prox" class="font-medium"></div></div>
          <div class="flex justify-between border-b pb-1"><div class="text-slate-500">Inspe√ß√£o</div><div id="dlg-insp" class="font-medium"></div></div>
          <div class="flex justify-between border-b pb-1"><div class="text-slate-500">Seguro</div><div id="dlg-seg" class="font-medium"></div></div>
          <div class="flex justify-between border-b pb-1"><div class="text-slate-500">KM</div><div id="dlg-km" class="font-medium"></div></div>
          <div class="hidden flex justify-between border-b pb-1" id="dlg-preco-row"><div class="text-slate-500">Valor compra</div><div id="dlg-preco" class="font-semibold"></div></div>
        </div>
        <div>
          <div class="text-slate-500">Observa√ß√µes</div>
          <div id="dlg-obs"></div>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Config Dialog -->
  <dialog id="cfg" class="rounded-2xl border p-0 w-[min(720px,95vw)] overflow-hidden">
    <form id="cfgForm" class="bg-white">
      <div class="p-4 border-b flex items-center justify-between">
        <div class="text-lg font-semibold">Configura√ß√µes de Branding</div>
        <div class="flex gap-2">
          <button type="button" id="cfgReset" class="px-3 py-2 text-sm rounded-md border bg-white">Repor</button>
          <button type="button" id="cfgClose" class="px-3 py-2 text-sm rounded-md border bg-white">Fechar</button>
          <button type="submit" class="px-3 py-2 text-sm rounded-md border bg-slate-900 text-white">Guardar</button>
        </div>
      </div>
      <div class="p-5 grid gap-4 md:grid-cols-5">
        <div class="md:col-span-3 grid gap-3">
          <label class="grid gap-1">
            <span class="text-xs text-slate-500">Nome da p√°gina</span>
            <input id="cfgTitle" class="border rounded-lg px-3 py-2" placeholder="Ex.: Frota XYZ" />
          </label>
          <label class="grid gap-1">
            <span class="text-xs text-slate-500">URL do logo (PNG/JPG/SVG)</span>
            <input id="cfgLogo" class="border rounded-lg px-3 py-2" placeholder="https://.../logo.png" />
          </label>
          <p class="text-xs text-slate-500">Dica: podes usar imagens do GitHub (raw.githubusercontent.com ou cdn.jsdelivr.net) ou Google Drive com partilha p√∫blica.</p>
        </div>
        <div class="md:col-span-2">
          <div class="text-xs text-slate-500 mb-2">Pr√©‚Äëvisualiza√ß√£o</div>
          <div class="border rounded-xl p-4 flex items-center gap-3">
            <span class="grid place-items-center w-12 h-12 rounded-xl bg-slate-900 text-white overflow-hidden">
              <img id="cfgPreviewLogo" class="w-full h-full object-cover hidden" alt="Preview logo"/>
              <span id="cfgPreviewEmoji">üöó</span>
            </span>
            <div class="font-semibold" id="cfgPreviewTitle">Cat√°logo de Viaturas</div>
          </div>
        </div>
      </div>
    </form>
  </dialog>

  <script>
    // ====== Config ======
    const LS_TITLE = 'GARAGEM_TITLE';
    const LS_LOGO = 'GARAGEM_LOGO';
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRF0MjiPepVk_w5EjX1F9ZdIjWqUMAW-h-nXUSBRQIWXRIQ3QQ00ckVT58MNnQsuPRJgF7HuzfnnbSW/pub?output=csv";
    const ADMIN_PASS = "775500";

    // ====== Utils ======
    const parseDate = (s)=>{ if(!s) return null; if(/^\d{2}\/\d{2}\/\d{4}$/.test(s)){ const [d,m,y]=s.split('/').map(Number); return new Date(y,m-1,d); } if(/^\d{4}-\d{2}-\d{2}$/.test(s)){ const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); } const d=new Date(s); return isNaN(+d)?null:d; };
    const addMonths = (d,m)=>{ if(!d) return null; const x=new Date(d); const day=x.getDate(); x.setMonth(x.getMonth()+m); if(x.getDate()<day) x.setDate(0); return x; };
    const fmt = (d)=> d? String(d.getDate()).padStart(2,'0')+"/"+String(d.getMonth()+1).padStart(2,'0')+"/"+d.getFullYear() : '';
    const toNum = (v)=>{ const n=Number(String(v||'').replace(/[^0-9.,-]/g,'').replace(/\.(?=.*\.)/g,'').replace(',', '.')); return isFinite(n)?n:null; };

    function csvToObjects(csv){
      const rows=[]; let i=0, f='', q=false, r=[];
      while(i<csv.length){ const c=csv[i]; if(q){ if(c==='"'&&csv[i+1]==='"'){f+='"';i++;} else if(c==='"'){q=false;} else f+=c; } else { if(c==='"') q=true; else if(c===','){ r.push(f.trim()); f=''; } else if(c==='\n'){ r.push(f.trim()); rows.push(r); r=[]; f=''; } else if(c!=='\r'){ f+=c; } } i++; }
      if(f.length||r.length){ r.push(f.trim()); rows.push(r); }
      if(!rows.length) return [];
      const header = rows[0].map(h=>h.toLowerCase());
      return rows.slice(1).filter(r=>r.length && r.some(x=>x!=='')).map((r,i)=>{ const o={}; header.forEach((h,idx)=> o[h]=(r[idx]??'').trim()); return o; });
    }

    const pick=(obj, ...names)=>{ for(const n of names){ const v=obj[n]; if(v && String(v).trim()!=='') return v; } return ''; };
    const comp = {
      nome:(a,b)=> a.nome.localeCompare(b.nome,'pt',{sensitivity:'base'}),
      matricula:(a,b)=> (a.matricula||'').localeCompare(b.matricula||'','pt',{numeric:true}),
      prox:(a,b)=>{ const pa=a.prox? parseDate(a.prox) : null; const pb=b.prox? parseDate(b.prox) : null; return (pa?+pa:Infinity) - (pb?+pb:Infinity); }
    };

    function normalize(row, i){
      const marca = pick(row,'marca');
      const modelo = pick(row,'modelo');
      const nome = pick(row,'nome','viatura') || [marca,modelo].filter(Boolean).join(' ') || `Viatura ${i+1}`;
      const foto1 = pick(row,'foto_url','foto','photo','foto1','foto 1','imagem','imagem 1');
      const foto2 = pick(row,'foto2','foto 2','imagem2','imagem 2');
      const categoria = pick(row,'categoria','tipo');
      const matricula = pick(row,'matricula','matr√≠cula');
      const km = pick(row,'km','km da ultima revis√£o','km √∫ltima revis√£o');
     
