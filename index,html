<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cat√°logo de Viaturas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card:hover{ box-shadow: 0 8px 30px rgba(2,6,23,.08) }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-white to-slate-50 text-slate-900">
  <header class="sticky top-0 z-40 bg-white/70 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <span class="text-2xl">üöó</span>
      <span class="text-xl font-semibold">Cat√°logo de Viaturas</span>
      <span id="count" class="text-sm text-slate-500"></span>
      <div class="ml-auto flex items-center gap-2 w-full max-w-md">
        <span class="text-slate-500">üîé</span>
        <input id="q" class="w-full border rounded-md px-3 py-2 text-sm" placeholder="Procurar por nome, marca, matr√≠cula..." />
      </div>
      <div class="ml-3 flex items-center gap-2">
        <select id="role" class="border rounded-md px-2 py-1 text-sm">
          <option value="user" selected>Utilizador</option>
          <option value="admin">Admin</option>
        </select>
        <span id="badge" class="text-xs px-2 py-1 rounded-full border bg-slate-50 text-slate-700 border-slate-200">Utilizador</span>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <div id="notice" class="hidden mb-4 text-sm rounded-lg border p-3"></div>
    <div id="grid" class="grid gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4"></div>
  </main>

  <template id="card-tpl">
    <div class="card overflow-hidden rounded-xl border bg-white">
      <a class="block" data-link>
        <div class="aspect-video bg-slate-100 flex items-center justify-center overflow-hidden" data-figure>
          <div class="text-slate-400 text-sm">üñºÔ∏è Sem foto</div>
        </div>
      </a>
      <div class="p-3 border-t">
        <div class="text-base font-medium flex items-center gap-2">
          <span class="truncate" data-nome></span>
          <span class="ml-auto text-xs px-2 py-0.5 rounded-full bg-slate-50 text-slate-700 border border-slate-200" data-matricula></span>
        </div>
        <div class="mt-2 text-sm text-slate-600 flex justify-between">
          <span class="truncate" data-categoria></span>
          <span class="font-medium" data-proxmanut></span>
        </div>
        <div class="text-sm" data-preco style="display:none"></div>
      </div>
    </div>
  </template>

  <dialog id="dlg" class="rounded-xl border p-0 w-[min(900px,95vw)]">
    <div class="p-3 border-b flex items-center justify-between">
      <div class="text-lg font-semibold" id="dlg-title"></div>
      <button id="dlg-close" class="px-2 py-1 text-sm rounded-md border">Fechar</button>
    </div>
    <div class="grid md:grid-cols-5 gap-0">
      <div class="md:col-span-3 bg-slate-100">
        <div class="aspect-video overflow-hidden">
          <img id="dlg-main" class="w-full h-full object-cover" alt="Foto principal" />
        </div>
        <div class="p-2 border-t flex gap-2" id="dlg-thumbs"></div>
      </div>
      <div class="md:col-span-2 p-4 grid gap-2 text-sm">
        <div class="flex justify-between border-b pb-1"><div class="text-slate-500">Matr√≠cula</div><div id="dlg-matricula" class="font-medium"></div></div>
        <div class="flex justify-between border-b pb-1"><div class="text-slate-500">Categoria</div><div id="dlg-categoria" class="font-medium"></div></div>
        <div class="flex justify-between border-b pb-1"><div class="text-slate-500">Pr√≥x. Manuten√ß√£o</div><div id="dlg-prox" class="font-medium"></div></div>
        <div class="flex justify-between border-b pb-1"><div class="text-slate-500">Inspe√ß√£o</div><div id="dlg-insp" class="font-medium"></div></div>
        <div class="flex justify-between border-b pb-1"><div class="text-slate-500">Seguro</div><div id="dlg-seg" class="font-medium"></div></div>
        <div class="flex justify-between border-b pb-1"><div class="text-slate-500">KM</div><div id="dlg-km" class="font-medium"></div></div>
        <div class="hidden flex justify-between border-b pb-1" id="dlg-preco-row"><div class="text-slate-500">Valor compra</div><div id="dlg-preco" class="font-semibold"></div></div>
        <div>
          <div class="text-slate-500">Observa√ß√µes</div>
          <div id="dlg-obs"></div>
        </div>
      </div>
    </div>
  </dialog>

  <script>
    // ======= CONFIG (apenas CSV para m√°xima simplicidade) =======
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRF0MjiPepVk_w5EjX1F9ZdIjWqUMAW-h-nXUSBRQIWXRIQ3QQ00ckVT58MNnQsuPRJgF7HuzfnnbSW/pub?gid=0&single=true&output=csv";
    const ADMIN_PASS = "775500"; // mostra valor de compra

    // ======= Utils =======
    const parseDate = (s)=>{ if(!s) return null; if(/^\d{2}\/\d{2}\/\d{4}$/.test(s)){ const [d,m,y]=s.split('/').map(Number); return new Date(y,m-1,d); } if(/^\d{4}-\d{2}-\d{2}$/.test(s)){ const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); } const d=new Date(s); return isNaN(+d)?null:d; };
    const addMonths = (d,m)=>{ if(!d) return null; const x=new Date(d); const day=x.getDate(); x.setMonth(x.getMonth()+m); if(x.getDate()<day) x.setDate(0); return x; };
    const fmt = (d)=> d? String(d.getDate()).padStart(2,'0')+"/"+String(d.getMonth()+1).padStart(2,'0')+"/"+d.getFullYear() : '';
    const toNum = (v)=>{ const n=Number(String(v||'').replace(/[^0-9.,-]/g,'').replace(/\.(?=.*\.)/g,'').replace(',', '.')); return isFinite(n)?n:null; };

    function csvToObjects(csv){
      const rows=[]; let i=0, f='', q=false, r=[];
      while(i<csv.length){ const c=csv[i]; if(q){ if(c==='"'&&csv[i+1]==='"'){f+='"';i++;} else if(c==='"'){q=false;} else f+=c; } else { if(c==='"') q=true; else if(c===','){ r.push(f.trim()); f=''; } else if(c==='\n'){ r.push(f.trim()); rows.push(r); r=[]; f=''; } else if(c!=='\r'){ f+=c; } } i++; }
      if(f.length||r.length){ r.push(f.trim()); rows.push(r); }
      if(!rows.length) return [];
      const header = rows[0].map(h=>h.toLowerCase());
      return rows.slice(1).filter(r=>r.length && r.some(x=>x!=='')).map((r,i)=>{ const o={}; header.forEach((h,idx)=> o[h]=(r[idx]??'').trim()); return o; });
    }

    const pick=(obj, ...names)=>{ for(const n of names){ const v=obj[n]; if(v && String(v).trim()!=='') return v; } return ''; };

    function normalize(row, i){
      const marca = pick(row,'marca');
      const modelo = pick(row,'modelo');
      const nome = pick(row,'nome','viatura') || [marca,modelo].filter(Boolean).join(' ') || `Viatura ${i+1}`;
      const foto1 = pick(row,'foto_url','foto','photo','foto1','foto 1');
      const foto2 = pick(row,'foto2','foto 2');
      const categoria = pick(row,'categoria','tipo');
      const matricula = pick(row,'matricula','matr√≠cula');
      const km = pick(row,'km','km da ultima revis√£o','km √∫ltima revis√£o');
      const estado = pick(row,'estado') || 'Operacional';
      const dUlt = pick(row,'data da √∫ltima revis√£o','data ultima revis√£o','data_ultima_revisao');
      const prox = dUlt ? fmt(addMonths(parseDate(dUlt),12)) : '';
      const insp = fmt(parseDate(pick(row,'inspecao','inspe√ß√£o','data inspe√ß√£o')));
      const seg = fmt(parseDate(pick(row,'seguro','data seguro')));
      const preco = toNum(pick(row,'valor compra','valor_compra','pre√ßo','preco'));
      const obs = pick(row,'observacoes','observa√ß√µes') || pick(row,'descri√ß√£o da √∫ltima revis√£o','descricao_ultima_revisao');
      const id = pick(row,'id') || String(i+1);
      return { id, nome, foto1, foto2, categoria, matricula, km, estado, prox, insp, seg, preco, obs };
    }

    // ======= Estado & Render =======
    const state = { data:[], filtered:[], role:'user' };

    function showNotice(type, msg){
      const el=document.getElementById('notice');
      el.className = `mb-4 text-sm rounded-lg border p-3 ${type==='err'?'text-red-700 bg-red-50 border-red-200':'text-emerald-700 bg-emerald-50 border-emerald-200'}`;
      el.textContent = msg; el.classList.remove('hidden');
    }
    function hideNotice(){ document.getElementById('notice').classList.add('hidden'); }

    function render(){
      document.getElementById('count').textContent = `${state.filtered.length} viaturas`;
      const grid = document.getElementById('grid'); grid.innerHTML='';
      const tpl = document.getElementById('card-tpl');
      for(const it of state.filtered){
        const node = tpl.content.cloneNode(true);
        const fig = node.querySelector('[data-figure]');
        if(it.foto1){ fig.innerHTML = `<img src="${it.foto1}" alt="${it.nome}" class="w-full h-full object-cover"/>`; }
        node.querySelector('[data-nome]').textContent = it.nome;
        node.querySelector('[data-matricula]').textContent = it.matricula || '‚Äî';
        node.querySelector('[data-categoria]').textContent = it.categoria || '‚Äî';
        node.querySelector('[data-proxmanut]').textContent = it.prox || '‚Äî';
        const preco = node.querySelector('[data-preco]');
        if(state.role==='admin' && it.preco!=null){ preco.style.display='block'; preco.innerHTML = `Valor compra: <strong>‚Ç¨ ${Number(it.preco).toLocaleString('pt-PT')}</strong>`; }
        const link = node.querySelector('[data-link]');
        link.addEventListener('click',(e)=>{ e.preventDefault(); openDialog(it); });
        grid.appendChild(node);
      }
    }

    function openDialog(it){
      const dlg=document.getElementById('dlg');
      document.getElementById('dlg-title').textContent = it.nome;
      document.getElementById('dlg-matricula').textContent = it.matricula||'‚Äî';
      document.getElementById('dlg-categoria').textContent = it.categoria||'‚Äî';
      document.getElementById('dlg-prox').textContent = it.prox||'‚Äî';
      document.getElementById('dlg-insp').textContent = it.insp||'‚Äî';
      document.getElementById('dlg-seg').textContent = it.seg||'‚Äî';
      document.getElementById('dlg-km').textContent = it.km||'‚Äî';
      const rowPreco = document.getElementById('dlg-preco-row');
      if(state.role==='admin' && it.preco!=null){ rowPreco.classList.remove('hidden'); document.getElementById('dlg-preco').textContent = '‚Ç¨ '+Number(it.preco).toLocaleString('pt-PT'); }
      else { rowPreco.classList.add('hidden'); }
      const thumbs = document.getElementById('dlg-thumbs'); thumbs.innerHTML='';
      const main = document.getElementById('dlg-main');
      if(it.foto1){ main.src = it.foto1; const b1=document.createElement('button'); b1.className='border rounded overflow-hidden'; b1.innerHTML=`<img src="${it.foto1}" class="w-20 h-14 object-cover">`; b1.onclick=()=> main.src=it.foto1; thumbs.appendChild(b1);} else { main.removeAttribute('src'); }
      if(it.foto2){ const b2=document.createElement('button'); b2.className='border rounded overflow-hidden'; b2.innerHTML=`<img src="${it.foto2}" class="w-20 h-14 object-cover">`; b2.onclick=()=> main.src=it.foto2; thumbs.appendChild(b2); }
      document.getElementById('dlg-obs').textContent = it.obs || '‚Äî';
      dlg.showModal();
    }

    // ======= Boot =======
    async function load(){
      hideNotice();
      document.getElementById('count').textContent = 'a carregar‚Ä¶';
      try{
        const res = await fetch(CSV_URL + '&_cb=' + Date.now(), { cache:'no-store' });
        if(!res.ok) throw new Error('Falha HTTP '+res.status);
        const text = await res.text();
        const rows = csvToObjects(text);
        const norm = rows.map(normalize);
        state.data = norm;
        state.filtered = norm;
        showNotice('ok', `Fonte ligada ‚úÖ (${rows.length} linhas)`);
        render();
      }catch(err){
        showNotice('err', 'N√£o consegui ler a folha CSV. Verifica se est√° publicada e acess√≠vel. Detalhe: '+ (err.message||err));
        state.data=[]; state.filtered=[]; render();
      }
    }

    // ======= UI =======
    document.getElementById('q').addEventListener('input', (e)=>{
      const v = e.target.value.toLowerCase();
      state.filtered = state.data.filter(it=> [it.nome,it.matricula,it.categoria].some(x=> (x||'').toLowerCase().includes(v)) );
      render();
    });
    document.getElementById('role').addEventListener('change', (e)=>{
      if(e.target.value==='admin'){
        const pwd = prompt('Password de admin:');
        if(pwd===ADMIN_PASS){ state.role='admin'; document.getElementById('badge').textContent='Admin'; document.getElementById('badge').className='text-xs px-2 py-1 rounded-full border bg-emerald-50 text-emerald-700 border-emerald-200'; }
        else { alert('Password incorreta. Mantendo Utilizador.'); e.target.value='user'; state.role='user'; document.getElementById('badge').textContent='Utilizador'; document.getElementById('badge').className='text-xs px-2 py-1 rounded-full border bg-slate-50 text-slate-700 border-slate-200'; }
      }else{ state.role='user'; document.getElementById('badge').textContent='Utilizador'; document.getElementById('badge').className='text-xs px-2 py-1 rounded-full border bg-slate-50 text-slate-700 border-slate-200'; }
      render();
    });
    document.getElementById('dlg-close').addEventListener('click', ()=> document.getElementById('dlg').close());

    load();
  </script>
</body>
</html>
